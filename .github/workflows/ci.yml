name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 ruff
      
      - name: Run Black
        run: black --check --diff scripts/ tests/
      
      - name: Run Ruff
        run: ruff check scripts/ tests/
      
      - name: Run Flake8
        run: flake8 scripts/ tests/ --max-line-length=100 --ignore=E501,W503

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-automation.txt
      
      - name: Run tests
        run: pytest tests/ -v --tb=short

  validate-manifests:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema
      
      - name: Validate manifests
        run: |
          python -c "
          import json
          import jsonschema
          from pathlib import Path
          
          schema_path = Path('scripts/manifest_schema.json')
          with open(schema_path) as f:
              schema = json.load(f)
          
          bucket_dir = Path('bucket')
          errors = []
          
          for manifest_file in bucket_dir.glob('*.json'):
              try:
                  with open(manifest_file) as f:
                      manifest = json.load(f)
                  jsonschema.validate(manifest, schema)
                  print(f'✅ {manifest_file.name}')
              except json.JSONDecodeError as e:
                  errors.append(f'{manifest_file.name}: Invalid JSON - {e}')
              except jsonschema.ValidationError as e:
                  errors.append(f'{manifest_file.name}: Schema validation - {e.message}')
              except Exception as e:
                  errors.append(f'{manifest_file.name}: {e}')
          
          if errors:
              for err in errors:
                  print(f'❌ {err}')
              exit(1)
          
          print(f'\\n✅ All {len(list(bucket_dir.glob(\"*.json\")))} manifests validated successfully')
          "

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-automation.txt
      
      - name: Run tests
        run: pytest tests/ -v --tb=short
